# [5-3] Implement at-point endpoint with DTOs and validation

[Back to task list](./tasks.md)

## Description

Implement the `/api/v1/parcels/at-point` endpoint with request DTOs, response DTOs, validation using go-playground/validator, and Gin handler. This endpoint allows users to click anywhere on the map and retrieve property information for that location.

This task integrates the repository and service layers created in previous tasks into an HTTP API following established patterns from the API reference.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-21 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Create `api/internal/handlers/parcel_handler.go` with ParcelHandler struct
2. Define request DTO for query parameters with validation tags
3. Define response DTO for parcel data with GeoJSON
4. Implement handler method for at-point endpoint
5. Use `middleware.GetLogger(c)` for structured logging
6. Use `errors` package helpers for error responses
7. Return 400 for invalid coordinates
8. Return 404 when no parcel found
9. Return 200 with parcel data when found
10. Register route in router: `GET /api/v1/parcels/at-point`

## Implementation Plan

1. Create `api/internal/handlers/parcel_handler.go`
2. Define handler struct:
   ```go
   type ParcelHandler struct {
       service services.ParcelService
   }
   
   func NewParcelHandler(service services.ParcelService) *ParcelHandler {
       return &ParcelHandler{service: service}
   }
   ```
3. Define DTOs in same file:
   ```go
   type AtPointRequest struct {
       Lat float64 `form:"lat" binding:"required,min=-90,max=90"`
       Lng float64 `form:"lng" binding:"required,min=-180,max=180"`
   }
   
   type ParcelResponse struct {
       Parcel *ParcelData `json:"parcel"`
   }
   
   type ParcelData struct {
       ID            uint                   `json:"id"`
       ParcelID      string                 `json:"parcel_id,omitempty"`
       OwnerName     string                 `json:"owner_name,omitempty"`
       SitusAddress  string                 `json:"situs_address,omitempty"`
       Acres         float64                `json:"acres,omitempty"`
       PropType      string                 `json:"prop_type,omitempty"`
       LandUse       string                 `json:"land_use,omitempty"`
       CountyName    string                 `json:"county_name"`
       Geometry      map[string]interface{} `json:"geometry"`
   }
   ```
4. Implement `AtPoint(c *gin.Context)` handler:
   - Get logger from context
   - Bind query params to AtPointRequest
   - Handle validation errors with `errors.ValidationError()`
   - Call `service.GetParcelAtPoint()`
   - Handle service.ErrParcelNotFound → 404
   - Handle service.ErrInvalidCoordinates → 400
   - Handle other errors → 500
   - Map TaxParcel to ParcelData
   - Return 200 with ParcelResponse
5. Add route in `cmd/server/main.go`:
   ```go
   v1 := router.Group("/api/v1")
   {
       parcels := v1.Group("/parcels")
       {
           parcels.GET("/at-point", parcelHandler.AtPoint)
       }
   }
   ```

## Test Plan

**Objective**: Verify endpoint handles requests correctly and returns proper responses

**Test Scope**: HTTP endpoint testing with service layer integration

**Environment & Setup**: 
- Integration test with real HTTP server
- Mock or real service layer (integration test preferred)
- Test database with sample parcel data

**Key Test Scenarios**:
1. **Success case**: Valid lat/lng returns 200 with parcel JSON
2. **Not found**: Valid coordinates with no parcel returns 404
3. **Missing parameters**: No lat or lng returns 400 validation error
4. **Invalid latitude**: Lat out of range returns 400
5. **Invalid longitude**: Lng out of range returns 400
6. **Invalid parameter types**: Non-numeric values return 400
7. **Response format**: Verify JSON structure matches spec
8. **Request ID**: Response includes X-Request-ID header
9. **CORS headers**: Response includes CORS headers
10. **Logging**: Verify structured logs emitted

**Success Criteria**:
- All HTTP status codes correct
- Error responses follow standard format
- Success response includes all required fields
- GeoJSON geometry properly formatted
- Response time < 200ms for test data

## Verification

- [ ] parcel_handler.go created with handler struct
- [ ] AtPointRequest DTO with validation tags
- [ ] ParcelResponse and ParcelData DTOs defined
- [ ] AtPoint handler method implemented
- [ ] Uses middleware.GetLogger(c) for logging
- [ ] Uses errors package helpers for responses
- [ ] Route registered in main.go
- [ ] Integration tests pass
- [ ] Returns proper status codes (200, 400, 404)
- [ ] Response format matches PRD specification
- [ ] Code compiles and lints cleanly

## Files Modified

- `api/internal/handlers/parcel_handler.go` (created)
- `api/internal/handlers/parcel_handler_test.go` (created - integration tests)
- `api/cmd/server/main.go` (updated - route registration)

