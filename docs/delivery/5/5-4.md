# [5-4] Extend repository and service for nearby query

[Back to task list](./tasks.md)

## Description

Extend the parcel repository and service layers to support the nearby properties query using PostGIS ST_DWithin for radius-based spatial searches. This allows users to find all properties within a specified distance of a point.

This task adds the second spatial query capability to the existing repository and service from tasks 5-1 and 5-2.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-21 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-21 12:15:00 | Status Change | Proposed | InProgress | Starting implementation | AI_Agent |
| 2025-10-21 14:56:00 | Status Change | InProgress | Review | Implementation complete, all tests pass, code lints cleanly | AI_Agent |
| 2025-10-21 15:00:00 | Status Change | Review | Done | Approved and marked complete | User |

## Requirements

1. Add `FindNearby` method to `ParcelRepository` interface
2. Implement `FindNearby` with ST_DWithin query
3. Support radius parameter (in meters)
4. Return results ordered by distance
5. Include distance in results
6. Add `GetNearbyParcels` method to `ParcelService` interface
7. Implement service method with validation
8. Validate radius range (1 to 5000 meters)
9. Follow established patterns for error handling and logging

## Implementation Plan

### Repository Layer

1. Update `ParcelRepository` interface in `parcel_repository.go`:
   ```go
   type ParcelWithDistance struct {
       Parcel   models.TaxParcel
       Distance float64 // meters
   }
   
   type ParcelRepository interface {
       FindByPoint(ctx context.Context, lat, lng float64) (*models.TaxParcel, error)
       FindNearby(ctx context.Context, lat, lng float64, radiusMeters int) ([]ParcelWithDistance, error)
   }
   ```
2. Implement `FindNearby` using PostGIS geography:
   ```sql
   SELECT 
       id, object_id, pin, pid, state_cd, block, lot, tract,
       owner_name, owner_address, situs, as_code, legal_description,
       imprv_actual_year_built, imprv_main_area,
       p_year, p_version, p_roll_corr, taxing_units, exemptions,
       county_name, ST_AsGeoJSON(geom) as geometry,
       created_at, updated_at,
       ST_Distance(
           geom::geography, 
           ST_SetSRID(ST_MakePoint($1, $2), 4326)::geography
       ) as distance_meters
   FROM tax_parcels
   WHERE ST_DWithin(
       geom::geography,
       ST_SetSRID(ST_MakePoint($1, $2), 4326)::geography,
       $3
   )
   ORDER BY distance_meters
   LIMIT 20
   ```
3. Scan results into slice of `ParcelWithDistance`

### Service Layer

1. Update `ParcelService` interface in `parcel_service.go`:
   ```go
   type ParcelService interface {
       GetParcelAtPoint(ctx context.Context, lat, lng float64) (*models.TaxParcel, error)
       GetNearbyParcels(ctx context.Context, lat, lng float64, radiusMeters int) ([]repository.ParcelWithDistance, error)
   }
   ```
2. Implement `GetNearbyParcels`:
   - Validate lat/lng ranges
   - Validate radius: 1 ≤ radius ≤ 5000
   - Call `repo.FindNearby()`
   - Log query with parameters
   - Return results
3. Define validation error:
   ```go
   var ErrInvalidRadius = errors.New("radius must be between 1 and 5000 meters")
   ```

## Test Plan

**Objective**: Verify nearby query returns parcels within specified radius, ordered by distance

**Test Scope**: Repository and service layers with spatial distance queries

**Environment & Setup**:
- Integration test with PostgreSQL + PostGIS
- Test database with multiple parcels at known distances
- Unit test for service validation with mocked repository

**Mocking Strategy**: 
- Repository: Integration test with real database
- Service: Unit test with mocked repository

**Key Test Scenarios**:

**Repository Tests**:
1. **Basic nearby query**: Returns parcels within radius
2. **Distance calculation**: Distances are accurate (within margin)
3. **Ordering**: Results ordered by distance (ascending)
4. **Radius filtering**: Parcels outside radius excluded
5. **Empty results**: No parcels in range returns empty slice
6. **Large radius**: Max radius (5000m) works correctly
7. **Small radius**: Min radius (1m) works correctly

**Service Tests**:
1. **Valid parameters**: Calls repository correctly
2. **Invalid radius - too small**: Radius < 1 returns error
3. **Invalid radius - too large**: Radius > 5000 returns error
4. **Invalid coordinates**: Out-of-range lat/lng returns error
5. **Repository error**: Database errors propagated
6. **Logging**: Structured logs include all parameters

**Success Criteria**:
- Distance calculations accurate within 1%
- Results ordered correctly by distance
- All validation rules enforced
- No performance degradation (query < 200ms)

## Verification

- [x] ParcelWithDistance struct defined in repository
- [x] FindNearby added to ParcelRepository interface
- [x] FindNearby implemented with ST_DWithin
- [x] Query uses geography casting for accuracy
- [x] Results ordered by distance
- [x] GetNearbyParcels added to ParcelService interface
- [x] Service validates radius range (1-5000)
- [x] ErrInvalidRadius defined
- [x] Repository integration tests pass
- [x] Service unit tests pass
- [x] Code compiles and lints cleanly

## Files Modified

- `api/internal/repository/parcel_repository.go` (updated)
- `api/internal/repository/parcel_repository_test.go` (updated)
- `api/internal/services/parcel_service.go` (updated)
- `api/internal/services/parcel_service_test.go` (updated)

