# [5-2] Create parcel service with GetParcelAtPoint method

[Back to task list](./tasks.md)

## Description

Implement the parcel service layer with the `GetParcelAtPoint` method that contains business logic for point-in-polygon queries. The service layer sits between handlers and repositories, providing coordinate validation, error transformation (e.g., converting nil results to domain-specific "not found" semantics), and logging.

This follows the established pattern of separating data access (repository) from business logic (service).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-21 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-21 12:15:00 | Status Update | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-10-21 12:30:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | AI_Agent |
| 2025-10-21 12:35:00 | Status Update | Review | Done | Approved and marked as complete | User |

## Requirements

1. Create `api/internal/services/parcel_service.go`
2. Define `ParcelService` interface with `GetParcelAtPoint` method
3. Implement `parcelService` struct with repository and logger dependencies
4. Implement `GetParcelAtPoint(ctx context.Context, lat, lng float64) (*models.TaxParcel, error)` method
5. Validate coordinate ranges (lat: -90 to 90, lng: -180 to 180)
6. Call repository's FindByPoint method
7. Return appropriate errors for invalid inputs or not found cases
8. Add structured logging for operations
9. Follow established service patterns

## Implementation Plan

1. Create `api/internal/services/parcel_service.go`
2. Define interface:
   ```go
   type ParcelService interface {
       GetParcelAtPoint(ctx context.Context, lat, lng float64) (*models.TaxParcel, error)
   }
   ```
3. Define implementation struct:
   ```go
   type parcelService struct {
       repo repository.ParcelRepository
       log  *logger.Logger
   }
   
   func NewParcelService(repo repository.ParcelRepository, log *logger.Logger) ParcelService {
       return &parcelService{
           repo: repo,
           log:  log,
       }
   }
   ```
4. Implement `GetParcelAtPoint`:
   - Validate lat is between -90 and 90
   - Validate lng is between -180 and 180
   - Return validation error if out of range
   - Call `repo.FindByPoint(ctx, lng, lat)` (note: PostGIS uses lon,lat order)
   - Log query with coordinates
   - Return parcel or nil if not found
   - Return errors from repository
5. Define custom errors:
   ```go
   var (
       ErrInvalidCoordinates = errors.New("invalid coordinates")
       ErrParcelNotFound    = errors.New("parcel not found")
   )
   ```

## Test Plan

**Objective**: Verify service layer validates inputs and correctly delegates to repository

**Test Scope**: Service business logic with mocked repository

**Environment & Setup**: Unit test with mocked repository

**Mocking Strategy**: Mock ParcelRepository interface using testify/mock or manual mock

**Key Test Scenarios**:
1. **Valid coordinates - parcel found**: Returns parcel from repository
2. **Valid coordinates - not found**: Repository returns nil, service returns ErrParcelNotFound
3. **Invalid latitude**: Lat > 90 or < -90 returns validation error
4. **Invalid longitude**: Lng > 180 or < -180 returns validation error
5. **Repository error**: Database errors propagated correctly
6. **Context cancellation**: Cancelled context handled appropriately
7. **Logging**: Verify structured logs emitted for queries

**Success Criteria**:
- All validation rules enforced
- Repository called with correct parameters (lng, lat order)
- Errors appropriately transformed
- Logging includes relevant context
- 100% code coverage for service logic

## Verification

- [x] parcel_service.go created with interface and implementation
- [x] GetParcelAtPoint validates coordinate ranges
- [x] Custom errors defined (ErrInvalidCoordinates, ErrParcelNotFound)
- [x] Repository called with correct parameter order (lng, lat)
- [x] Structured logging includes coordinates and results
- [x] Unit tests pass with mocked repository
- [x] Code compiles without errors
- [x] golangci-lint passes with no errors

## Files Modified

- `api/internal/services/parcel_service.go` (created)
- `api/internal/services/parcel_service_test.go` (created - unit tests)

