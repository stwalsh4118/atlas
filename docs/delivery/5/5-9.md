# [5-9] E2E CoS Test for Point-in-Polygon Query API

[Back to task list](./tasks.md)

## Description

End-to-end test that verifies all Conditions of Satisfaction (CoS) for PBI 5 are met. This comprehensive test validates the entire API stack from HTTP requests through to database queries, ensuring all acceptance criteria from the PRD are satisfied.

This test serves as the final verification before marking the PBI as complete.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-21 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Create comprehensive E2E test suite
2. Test all three endpoints with real HTTP requests
3. Use real database with actual parcel data
4. Verify all 18 acceptance criteria from PRD
5. Include performance validation
6. Test error scenarios comprehensively
7. Validate response formats against PRD specs
8. Verify logging and monitoring

## Implementation Plan

1. Create `api/test/e2e/parcel_api_test.go`
2. Setup test environment:
   - Start real PostgreSQL + PostGIS
   - Load test parcel data (Montgomery County sample)
   - Start HTTP server with all middleware
   - Use httptest or real HTTP client
3. Implement test cases for all CoS:

### Test Cases (Mapped to PRD Acceptance Criteria)

**At-Point Endpoint Tests**:
1. ✅ CoS #1: GET /api/v1/parcels/at-point endpoint implemented
2. ✅ CoS #2: Validates lat/lng parameters correctly
3. ✅ CoS #3: Returns 400 for invalid coordinates
4. ✅ CoS #4: Returns 404 when no parcel found
5. ✅ CoS #5: Returns 200 with parcel data when found
6. ✅ CoS #6: GeoJSON geometry included in response

**Nearby Endpoint Tests**:
9. ✅ CoS #9: GET /api/v1/parcels/nearby endpoint implemented
10. ✅ CoS #10: Nearby query respects radius parameter
11. ✅ CoS #11: Results sorted by distance

**Get-By-ID Endpoint Tests**:
12. ✅ CoS #12: GET /api/v1/parcels/:id endpoint implemented
13. ✅ CoS #13: Can fetch parcel by database ID
14. ✅ CoS #14: Can fetch parcel by parcel_id string

**Cross-Cutting Concerns**:
15. ✅ CoS #15: All endpoints have proper error handling
16. ✅ CoS #16: Query execution time logged for each request
17. ✅ CoS #17: Integration tests cover happy path and error cases
18. ✅ CoS #18: API documentation updated with examples (manual verification)

**Performance Tests**:
7. ✅ CoS #7: Query completes in < 100ms for database with 50k parcels
8. ✅ CoS #8: EXPLAIN ANALYZE shows spatial index is used (covered in 5-8)

## Test Plan

**Objective**: Verify all acceptance criteria are met through end-to-end testing

**Test Scope**: Complete API stack with real HTTP, database, and middleware

**Environment & Setup**:
- Docker PostgreSQL 18 + PostGIS 3.5.1
- Load sample Montgomery County parcel data (≥1000 parcels)
- Real HTTP server with production middleware stack
- Real database connections (no mocks)

**Test Data Requirements**:
- At least 1000 parcels with valid geometries
- Parcels at known coordinates for deterministic testing
- Various property types and owners
- Valid GeoJSON geometries

**Test Structure**:
```go
func TestE2E_ParcelAPI(t *testing.T) {
    // Setup
    db := setupTestDatabase(t)
    server := setupTestServer(t, db)
    client := &http.Client{Timeout: 5 * time.Second}
    
    t.Run("AtPoint_Success", func(t *testing.T) { /* ... */ })
    t.Run("AtPoint_NotFound", func(t *testing.T) { /* ... */ })
    t.Run("AtPoint_InvalidCoordinates", func(t *testing.T) { /* ... */ })
    t.Run("Nearby_Success", func(t *testing.T) { /* ... */ })
    t.Run("Nearby_DefaultRadius", func(t *testing.T) { /* ... */ })
    t.Run("Nearby_SortedByDistance", func(t *testing.T) { /* ... */ })
    t.Run("GetByID_DatabaseID", func(t *testing.T) { /* ... */ })
    t.Run("GetByID_ParcelID", func(t *testing.T) { /* ... */ })
    t.Run("GetByID_NotFound", func(t *testing.T) { /* ... */ })
    t.Run("ErrorHandling_StandardFormat", func(t *testing.T) { /* ... */ })
    t.Run("Performance_AtPoint", func(t *testing.T) { /* ... */ })
    t.Run("Logging_RequestID", func(t *testing.T) { /* ... */ })
    t.Run("CORS_Headers", func(t *testing.T) { /* ... */ })
}
```

**Key Test Scenarios**:

1. **At-Point Success Flow**:
   - Request: GET /api/v1/parcels/at-point?lat=30.3477&lng=-95.4502
   - Assert: 200 status
   - Assert: Response has parcel object
   - Assert: parcel.geometry exists and is valid GeoJSON
   - Assert: parcel.county_name = "Montgomery"
   - Assert: X-Request-ID header present

2. **At-Point Not Found**:
   - Request: Valid coordinates in ocean/non-parcel area
   - Assert: 404 status
   - Assert: Error code = "NOT_FOUND"
   - Assert: Error message helpful

3. **At-Point Invalid Coordinates**:
   - Request: lat=999, lng=999
   - Assert: 400 status
   - Assert: Error code = "VALIDATION_ERROR"
   - Assert: Error details explain issue

4. **Nearby Success**:
   - Request: GET /api/v1/parcels/nearby?lat=30.3477&lng=-95.4502&radius=1000
   - Assert: 200 status
   - Assert: Response has parcels array
   - Assert: count field present
   - Assert: Each parcel has distance_meters field
   - Assert: Results sorted by distance ascending

5. **Nearby Default Radius**:
   - Request: No radius parameter
   - Assert: 200 status
   - Assert: Results limited to 1000m (default)

6. **Get By Database ID**:
   - Request: GET /api/v1/parcels/1
   - Assert: 200 status
   - Assert: Correct parcel returned

7. **Get By Parcel ID String**:
   - Request: GET /api/v1/parcels/R123456
   - Assert: 200 status
   - Assert: Correct parcel returned

8. **Performance Test**:
   - Run 100 at-point queries
   - Assert: P95 < 100ms
   - Assert: P99 < 150ms
   - Assert: No query > 500ms

9. **Error Format Consistency**:
   - Test multiple error scenarios
   - Assert: All use standard error format
   - Assert: All include request_id

10. **Logging Verification**:
    - Make test requests
    - Capture logs
    - Assert: Query timing logged
    - Assert: Request ID in logs
    - Assert: Structured fields present

**Success Criteria**:
- All 18 CoS from PRD verified as met
- All test cases pass consistently
- No flaky tests (run 10 times, all pass)
- Performance targets met
- Error handling comprehensive
- Logging and monitoring verified
- Response formats match PRD specs exactly

## Verification

- [ ] E2E test file created
- [ ] All 18 CoS mapped to test cases
- [ ] Test environment setup automated
- [ ] Test data loaded (≥1000 parcels)
- [ ] All test cases implemented
- [ ] At-point endpoint fully tested
- [ ] Nearby endpoint fully tested
- [ ] Get-by-id endpoint fully tested
- [ ] Error handling tested comprehensively
- [ ] Performance tests pass (< 100ms)
- [ ] Logging verification tests pass
- [ ] All tests pass consistently (10/10 runs)
- [ ] Test output documented in this file
- [ ] All CoS marked as verified ✅

## Implementation Notes

### Test Results

(To be filled in during implementation)

**Test Run Output**:
```
-- Test output here
```

**CoS Verification Checklist**:
- [ ] CoS #1: at-point endpoint exists
- [ ] CoS #2: lat/lng validation works
- [ ] CoS #3: 400 for invalid coords
- [ ] CoS #4: 404 when not found
- [ ] CoS #5: 200 with data when found
- [ ] CoS #6: GeoJSON in response
- [ ] CoS #7: < 100ms performance
- [ ] CoS #8: Spatial index used
- [ ] CoS #9: nearby endpoint exists
- [ ] CoS #10: radius parameter works
- [ ] CoS #11: sorted by distance
- [ ] CoS #12: get-by-id endpoint exists
- [ ] CoS #13: fetch by database ID works
- [ ] CoS #14: fetch by parcel_id works
- [ ] CoS #15: proper error handling
- [ ] CoS #16: query timing logged
- [ ] CoS #17: integration tests exist
- [ ] CoS #18: documentation updated

## Files Modified

- `api/test/e2e/parcel_api_test.go` (created)
- `api/test/e2e/testdata/` (created - test fixtures)
- `docs/delivery/5/5-9.md` (updated with results)

