# [5-5] Implement nearby endpoint with DTOs and validation

[Back to task list](./tasks.md)

## Description

Implement the `/api/v1/parcels/nearby` endpoint with request/response DTOs, validation, and Gin handler. This endpoint allows users to find properties within a specified radius of a location.

This task exposes the nearby query functionality from task 5-4 as an HTTP API endpoint.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-21 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Define request DTO for nearby query parameters
2. Define response DTO for nearby results with distances
3. Implement handler method for nearby endpoint
4. Support optional radius parameter (default: 1000, max: 5000)
5. Return 400 for invalid parameters
6. Return 200 with empty array when no parcels found
7. Register route: `GET /api/v1/parcels/nearby`
8. Follow established patterns from at-point endpoint

## Implementation Plan

1. Add DTOs to `parcel_handler.go`:
   ```go
   type NearbyRequest struct {
       Lat    float64 `form:"lat" binding:"required,min=-90,max=90"`
       Lng    float64 `form:"lng" binding:"required,min=-180,max=180"`
       Radius int     `form:"radius,omitempty,min=1,max=5000" default:"1000"`
   }
   
   type NearbyResponse struct {
       Parcels []ParcelWithDistance `json:"parcels"`
       Count   int                  `json:"count"`
   }
   
   type ParcelWithDistance struct {
       ID            uint                   `json:"id"`
       ParcelID      string                 `json:"parcel_id,omitempty"`
       OwnerName     string                 `json:"owner_name,omitempty"`
       Acres         float64                `json:"acres,omitempty"`
       CountyName    string                 `json:"county_name"`
       Distance      float64                `json:"distance_meters"`
       Geometry      map[string]interface{} `json:"geometry"`
   }
   ```
2. Implement `Nearby(c *gin.Context)` handler:
   - Get logger from context
   - Bind query params to NearbyRequest
   - Set default radius if not provided
   - Handle validation errors
   - Call `service.GetNearbyParcels()`
   - Handle errors appropriately
   - Map results to response DTOs
   - Return 200 with NearbyResponse (empty array if no results)
3. Add route in `cmd/server/main.go`:
   ```go
   parcels.GET("/nearby", parcelHandler.Nearby)
   ```

## Test Plan

**Objective**: Verify nearby endpoint returns correct results with proper validation

**Test Scope**: HTTP endpoint testing with service integration

**Environment & Setup**:
- Integration test with HTTP server
- Test database with parcels at known distances
- Real or mocked service layer

**Key Test Scenarios**:
1. **Success with default radius**: No radius param uses 1000m default
2. **Success with custom radius**: Radius param respected
3. **Empty results**: No parcels in range returns empty array with count=0
4. **Missing coordinates**: No lat/lng returns 400
5. **Invalid coordinates**: Out of range returns 400
6. **Invalid radius - too small**: Radius < 1 returns 400
7. **Invalid radius - too large**: Radius > 5000 returns 400
8. **Distance ordering**: Results ordered by distance ascending
9. **Distance values**: Distance field populated correctly
10. **Response format**: JSON structure matches spec

**Success Criteria**:
- Default radius (1000m) applied when not specified
- All validation errors return 400 with proper error format
- Empty results return 200 with empty array (not 404)
- Distance values accurate and in meters
- Results ordered by distance
- Request ID in response headers

## Verification

- [ ] NearbyRequest DTO with validation tags
- [ ] NearbyResponse and ParcelWithDistance DTOs defined
- [ ] Default radius (1000) applied when omitted
- [ ] Nearby handler method implemented
- [ ] Uses middleware.GetLogger(c) for logging
- [ ] Uses errors package helpers
- [ ] Route registered in main.go
- [ ] Integration tests pass
- [ ] Returns 200 for empty results (not 404)
- [ ] Response includes count field
- [ ] Code compiles and lints cleanly

## Files Modified

- `api/internal/handlers/parcel_handler.go` (updated)
- `api/internal/handlers/parcel_handler_test.go` (updated)
- `api/cmd/server/main.go` (updated - route registration)

