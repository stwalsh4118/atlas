# [5-7] Implement get-by-id endpoint with DTOs and validation

[Back to task list](./tasks.md)

## Description

Implement the `/api/v1/parcels/:id` endpoint with path parameter handling, response DTOs, and Gin handler. This endpoint allows users to fetch a specific property by its database ID or parcel identifier.

This task exposes the get-by-id functionality from task 5-6 as an HTTP API endpoint, completing all three parcel query endpoints.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-21 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Implement handler method for get-by-id endpoint
2. Use path parameter `:id` to capture identifier
3. Reuse existing `ParcelResponse` DTO from at-point endpoint
4. Return 400 for invalid ID format (empty, too long)
5. Return 404 when parcel not found
6. Return 200 with parcel data when found
7. Register route: `GET /api/v1/parcels/:id`
8. Follow established patterns

## Implementation Plan

1. Add method to `parcel_handler.go`:
   ```go
   func (h *ParcelHandler) GetByID(c *gin.Context) {
       log := middleware.GetLogger(c)
       id := c.Param("id")
       
       if log != nil {
           log.Info("Getting parcel by ID", map[string]interface{}{
               "id": id,
           })
       }
       
       // Validate ID
       if id == "" {
           errors.BadRequest(c, "Parcel ID is required", nil)
           return
       }
       
       if len(id) > 50 {
           errors.BadRequest(c, "Parcel ID too long (max 50 characters)", nil)
           return
       }
       
       // Call service
       parcel, err := h.service.GetParcelByID(c.Request.Context(), id)
       if err == services.ErrParcelNotFound {
           errors.NotFound(c, "Parcel not found")
           return
       }
       if err == services.ErrInvalidParcelID {
           errors.BadRequest(c, err.Error(), nil)
           return
       }
       if err != nil {
           errors.InternalServerError(c, "Failed to retrieve parcel", err)
           return
       }
       
       // Map to response (reuse mapper from AtPoint)
       response := mapParcelToResponse(parcel)
       c.JSON(http.StatusOK, response)
   }
   ```
2. Add helper function to map TaxParcel to ParcelResponse (extract from AtPoint handler):
   ```go
   func mapParcelToResponse(parcel *models.TaxParcel) ParcelResponse {
       // Convert TaxParcel to ParcelData DTO
       // Handle nullable fields appropriately
       // Return ParcelResponse struct
   }
   ```
3. Add route in `cmd/server/main.go`:
   ```go
   parcels.GET("/:id", parcelHandler.GetByID)
   ```

## Test Plan

**Objective**: Verify get-by-id endpoint correctly handles various ID formats and returns proper responses

**Test Scope**: HTTP endpoint testing with service integration

**Environment & Setup**:
- Integration test with HTTP server
- Test database with parcels having known IDs
- Real or mocked service layer

**Key Test Scenarios**:
1. **Get by database ID**: Numeric ID returns correct parcel
2. **Get by parcel ID**: String identifier returns correct parcel
3. **Not found**: Non-existent ID returns 404
4. **Empty ID**: Actually tests route matching (would be 404 not 400)
5. **Invalid ID - too long**: ID > 50 chars returns 400
6. **Special characters**: IDs with special chars handled safely
7. **Response format**: JSON matches ParcelResponse structure
8. **Request ID**: Response includes X-Request-ID header
9. **Logging**: Structured logs include ID parameter

**Success Criteria**:
- Both numeric and string IDs work via URL
- 404 for not found (consistent with at-point)
- 400 for validation errors
- 500 for unexpected errors
- Response format consistent with at-point endpoint
- No URL encoding issues with special characters

## Verification

- [ ] GetByID handler method implemented
- [ ] Path parameter `:id` extracted correctly
- [ ] ID validation (not empty, max length 50)
- [ ] Uses middleware.GetLogger(c) for logging
- [ ] Uses errors package helpers
- [ ] Reuses ParcelResponse DTO from at-point
- [ ] mapParcelToResponse helper extracted for reuse
- [ ] Route registered in main.go
- [ ] Integration tests pass
- [ ] Returns proper status codes (200, 400, 404, 500)
- [ ] Code compiles and lints cleanly

## Files Modified

- `api/internal/handlers/parcel_handler.go` (updated)
- `api/internal/handlers/parcel_handler_test.go` (updated)
- `api/cmd/server/main.go` (updated - route registration)

