# [3-4] Implement core import script

[Back to task list](./tasks.md)

## Description

Create the main import script that uses ogr2ogr to load GeoJSON data into PostgreSQL. This script will read the field mapping configuration, execute the import with proper parameters, and handle the complete import workflow including transaction management.

**Note**: Using GeoJSON format (our standard) with ogr2ogr for maximum compatibility and flexibility.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-20 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Accept GeoJSON file path and mapping configuration as arguments
2. Read field mapping configuration from JSON
3. Construct ogr2ogr command with appropriate parameters:
   - CRS transformation (-t_srs TARGET_CRS)
   - PostgreSQL connection string
   - Target table name (tax_parcels_staging)
   - Geometry column name
4. Execute import within a database transaction
5. Handle field name mapping with SQL INSERT from staging to final table
6. Support both full import and append modes
7. Provide database connection configuration (host, port, database, user)
8. Handle errors and provide clear error messages
9. Support dry-run mode to preview operations without executing

## Implementation Plan

1. Create script: `scripts/import-parcels.sh`
2. Implement command-line argument parsing:
   - `--file <path>` (GeoJSON file path)
   - `--mapping <config.json>`
   - `--db-host <host>`
   - `--db-name <database>`
   - `--db-user <user>`
   - `--mode <append|replace>`
   - `--dry-run`
3. Read and parse JSON mapping configuration
4. Extract source/target CRS from mapping config
5. Construct ogr2ogr command for staging import:
   ```bash
   ogr2ogr -f PostgreSQL \
     PG:"host=${HOST} dbname=${DB} user=${USER}" \
     ${GEOJSON_FILE} \
     -nln tax_parcels_staging \
     -t_srs EPSG:4326
   ```
6. Generate SQL to map fields from staging to final table:
   ```sql
   INSERT INTO tax_parcels (object_id, pin, owner_name, situs, geom)
   SELECT "OBJECTID", "PIN", "ownerName", "situs", geom
   FROM tax_parcels_staging;
   ```
7. Execute within transaction wrapper
8. Add error checking at each step
9. Provide clear status messages during import
10. Document usage and examples

## Test Plan

**Objective**: Verify the import script successfully loads GeoJSON data into PostgreSQL

**Test Scope**: Bash script execution and database integration

**Key Test Scenarios**:
1. Script accepts all required arguments
2. Script reads and parses JSON configuration
3. Script constructs valid ogr2ogr command
4. Script successfully imports Montgomery County GeoJSON (325k records)
5. CRS transformation is applied correctly (if needed)
6. Existing spatial index from migrations is used
7. Geometries are imported correctly
8. Script handles missing required arguments gracefully
9. Dry-run mode shows commands without executing

**Success Criteria**: 
- Script successfully imports test data
- All geometries are transformed to EPSG:4326
- Spatial index is created and functional
- Script provides clear progress and error messages
- Transaction rollback works on error

## Verification

- [ ] Script created at `scripts/import-parcels.sh`
- [ ] Script is executable (chmod +x)
- [ ] Script accepts all required arguments
- [ ] Script reads JSON mapping configuration
- [ ] Script constructs correct ogr2ogr command
- [ ] Script generates field mapping SQL
- [ ] Script executes within transaction
- [ ] CRS is verified (EPSG:4326 for Montgomery County)
- [ ] Script handles field name mapping via SQL
- [ ] Script includes error handling
- [ ] Script includes usage documentation
- [ ] Script tested with Montgomery County data subset
- [ ] Import completes successfully

## Files Modified

- `scripts/import-parcels.sh` (new)


