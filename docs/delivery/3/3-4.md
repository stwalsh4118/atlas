# [3-4] Implement core import script

[Back to task list](./tasks.md)

## Description

Create the main import script that uses shp2pgsql to load shapefile data into PostgreSQL with CRS transformation. This script will read the field mapping configuration, execute the import with proper parameters, and handle the complete import workflow including transaction management.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-20 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Accept shapefile path and mapping configuration as arguments
2. Read field mapping configuration from JSON
3. Construct shp2pgsql command with appropriate parameters:
   - CRS transformation (-s SOURCE:TARGET)
   - Spatial index creation (-I)
   - Geometry column name (-g geom)
   - Target table name (tax_parcels)
4. Execute import within a database transaction
5. Handle field name mapping (may require intermediate table)
6. Support both full import and append modes
7. Provide database connection configuration (host, port, database, user)
8. Handle errors and provide clear error messages
9. Support dry-run mode to preview SQL without executing

## Implementation Plan

1. Create script: `scripts/import-parcels.sh`
2. Implement command-line argument parsing:
   - `--shapefile <path>`
   - `--mapping <config.json>`
   - `--db-host <host>`
   - `--db-name <database>`
   - `--db-user <user>`
   - `--mode <append|replace>`
   - `--dry-run`
3. Read and parse JSON mapping configuration
4. Extract source CRS from mapping config
5. Construct shp2pgsql command:
   ```bash
   shp2pgsql -I -s ${SOURCE_CRS}:4326 -g geom ${SHAPEFILE} tax_parcels
   ```
6. Pipe output to psql with transaction wrapper:
   ```bash
   BEGIN; [import commands] COMMIT;
   ```
7. Handle field mapping (may need temp table approach)
8. Add error checking at each step
9. Provide clear status messages during import
10. Document usage and examples

## Test Plan

**Objective**: Verify the import script successfully loads shapefile data into PostgreSQL

**Test Scope**: Bash script execution and database integration

**Key Test Scenarios**:
1. Script accepts all required arguments
2. Script reads and parses JSON configuration
3. Script constructs valid shp2pgsql command
4. Script successfully imports small test dataset (< 100 records)
5. CRS transformation is applied correctly
6. Spatial index is created
7. Geometries are stored as MultiPolygon
8. Script handles missing required arguments gracefully
9. Dry-run mode generates SQL without executing

**Success Criteria**: 
- Script successfully imports test data
- All geometries are transformed to EPSG:4326
- Spatial index is created and functional
- Script provides clear progress and error messages
- Transaction rollback works on error

## Verification

- [ ] Script created at `scripts/import-parcels.sh`
- [ ] Script is executable (chmod +x)
- [ ] Script accepts all required arguments
- [ ] Script reads JSON mapping configuration
- [ ] Script constructs correct shp2pgsql command
- [ ] Script pipes to psql with transaction wrapper
- [ ] CRS transformation is applied (SOURCE â†’ EPSG:4326)
- [ ] Spatial index flag (-I) is included
- [ ] Script handles field name mapping
- [ ] Script includes error handling
- [ ] Script includes usage documentation
- [ ] Script tested with Montgomery County data subset
- [ ] Import completes successfully

## Files Modified

- `scripts/import-parcels.sh` (new)


