# [3-7] Create post-import validation script

[Back to task list](./tasks.md)

## Description

Create a comprehensive post-import validation script that verifies data integrity, tests spatial index functionality, and runs sample queries to ensure the imported data is working correctly. This script will serve as both a validation tool and a diagnostic tool.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-20 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Count total records imported
2. Check for NULL geometries
3. Check for NULL required fields (parcel_id)
4. Verify all geometries are in EPSG:4326
5. Verify all geometries are MultiPolygon type
6. Test spatial index with EXPLAIN query
7. Run sample point-in-polygon query
8. Run sample bounding box query
9. Calculate and report data statistics:
   - Min/max acreage
   - Number of unique owners
   - Geographic extent (bounding box)
10. Run VACUUM ANALYZE on table
11. Generate validation report
12. Exit with error code if critical issues found

## Implementation Plan

1. Create script: `scripts/post-import-validation.sh`
2. Accept database connection parameters
3. Run record count query:
   ```sql
   SELECT COUNT(*) FROM tax_parcels;
   ```
4. Check for NULL geometries:
   ```sql
   SELECT COUNT(*) FROM tax_parcels WHERE geom IS NULL;
   ```
5. Check for NULL parcel_ids:
   ```sql
   SELECT COUNT(*) FROM tax_parcels WHERE parcel_id IS NULL;
   ```
6. Verify CRS:
   ```sql
   SELECT DISTINCT ST_SRID(geom) FROM tax_parcels;
   ```
7. Verify geometry types:
   ```sql
   SELECT DISTINCT GeometryType(geom) FROM tax_parcels;
   ```
8. Test spatial index with EXPLAIN:
   ```sql
   EXPLAIN SELECT * FROM tax_parcels 
   WHERE ST_Intersects(geom, ST_MakePoint(-95.5, 30.2));
   ```
9. Run sample point-in-polygon query:
   ```sql
   SELECT parcel_id, owner_name 
   FROM tax_parcels 
   WHERE ST_Contains(geom, ST_SetSRID(ST_MakePoint(-95.5, 30.2), 4326));
   ```
10. Calculate statistics (acreage, owners, extent)
11. Run VACUUM ANALYZE
12. Generate summary report
13. Exit with appropriate code

## Test Plan

**Objective**: Verify post-import validation catches common issues and confirms data integrity

**Test Scope**: SQL validation queries and reporting

**Key Test Scenarios**:
1. Script detects NULL geometries
2. Script detects wrong CRS (if present)
3. Script confirms spatial index is used (EXPLAIN shows Index Scan)
4. Script successfully runs sample spatial queries
5. Script calculates statistics correctly
6. Script generates readable validation report
7. Script exits with error on critical issues

**Success Criteria**: 
- All validation checks pass for clean import
- Script provides clear, actionable report
- Spatial index is confirmed functional
- Sample queries return expected results
- Script integrates into import pipeline

## Verification

- [ ] Script created at `scripts/post-import-validation.sh`
- [ ] Script is executable (chmod +x)
- [ ] Record count check implemented
- [ ] NULL geometry check implemented
- [ ] NULL parcel_id check implemented
- [ ] CRS verification implemented
- [ ] Geometry type verification implemented
- [ ] Spatial index test with EXPLAIN implemented
- [ ] Sample point-in-polygon query implemented
- [ ] Sample bounding box query implemented
- [ ] Statistics calculation implemented
- [ ] VACUUM ANALYZE executed
- [ ] Validation report generated
- [ ] Script exits with proper codes
- [ ] Script tested with Montgomery County data
- [ ] Documentation includes example output

## Files Modified

- `scripts/post-import-validation.sh` (new)
- `scripts/import-parcels.sh` (modified to call validation)


