# [3-8] E2E CoS Test for Data Import Pipeline

[Back to task list](./tasks.md)

## Description

End-to-end test that validates all Conditions of Satisfaction (CoS) for PBI 3 are met. This test will execute the complete import pipeline from start to finish with real Montgomery County data and verify all acceptance criteria.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-20 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

Verify all PBI 3 acceptance criteria:

1. ✅ Import script accepts shapefile path as input
2. ✅ Script automatically detects source CRS
3. ✅ All geometries transformed to EPSG:4326
4. ✅ Polygons converted to MultiPolygon format
5. ✅ Invalid geometries are validated and fixed or logged
6. ✅ At least 10,000 parcels imported successfully
7. ✅ Import completes in reasonable time (< 5 minutes for 50k parcels)
8. ✅ Progress logging shows import status
9. ✅ Post-import validation confirms data integrity
10. ✅ Spatial index is functional after import (verify with EXPLAIN)
11. ✅ Sample point-in-polygon query returns results correctly
12. ✅ Documentation for running import with different counties
13. ✅ Error log captures any problematic records

## Implementation Plan

1. Create test script: `scripts/test-import-e2e.sh`
2. Prepare test environment:
   - Clean database (drop and recreate tax_parcels table)
   - Prepare Montgomery County shapefile
3. Execute complete import pipeline:
   ```bash
   # Validate shapefile
   ./scripts/validate-shapefile.sh <shapefile>
   
   # Run import
   ./scripts/import-parcels.sh \
     --shapefile <shapefile> \
     --mapping scripts/mappings/montgomery-tx.json \
     --db-name atlas
   
   # Post-import validation
   ./scripts/post-import-validation.sh --db-name atlas
   ```
4. Verify each CoS criterion programmatically:
   - Check import script accepts file argument ✓
   - Verify CRS detection in logs ✓
   - Query database to confirm SRID = 4326 ✓
   - Query database to confirm GeometryType = 'MULTIPOLYGON' ✓
   - Check validation log for invalid geometry handling ✓
   - Query record count >= 10,000 ✓
   - Measure and assert import duration < 5 minutes ✓
   - Verify progress messages in log file ✓
   - Check post-validation report shows success ✓
   - Parse EXPLAIN output for "Index Scan" ✓
   - Execute point-in-polygon query and verify results ✓
   - Check documentation files exist ✓
   - Verify error log exists and has expected format ✓
5. Generate E2E test report
6. Exit with success/failure code

## Test Plan

**Objective**: Verify the complete data import pipeline meets all acceptance criteria end-to-end

**Test Scope**: Full integration test of all import scripts and database functionality

**Environment & Setup**:
- Clean PostgreSQL database with tax_parcels table
- Montgomery County shapefile data
- All import scripts in place
- Database connection configured

**Key Test Scenarios**:

1. **Complete Import Workflow**
   - Run pre-import validation
   - Execute import with field mapping
   - Run geometry validation
   - Run post-import validation
   - All steps complete successfully

2. **Data Integrity**
   - All records imported (count matches source)
   - All geometries in correct CRS (EPSG:4326)
   - All geometries are MultiPolygon type
   - No NULL geometries
   - Required fields populated

3. **Performance**
   - Import of 50k records completes in < 5 minutes
   - Progress updates appear during import
   - Spatial index is created and functional

4. **Error Handling**
   - Invalid geometries are logged
   - Error log captures issues
   - Import can recover from geometry errors

5. **Query Functionality**
   - Point-in-polygon query returns correct results
   - Spatial index is used (EXPLAIN confirms)
   - Query performance is acceptable

**Success Criteria**: 
- All 13 CoS criteria are met
- E2E test script exits with success code
- Test report shows all assertions passed
- Montgomery County data is fully imported and queryable
- All generated documentation is present

## Verification

- [ ] E2E test script created: `scripts/test-import-e2e.sh`
- [ ] Script prepares clean test environment
- [ ] Script executes full import pipeline
- [ ] Script verifies all 13 CoS criteria programmatically
- [ ] Script generates test report
- [ ] All CoS criteria pass with Montgomery County data
- [ ] Import time < 5 minutes for 50k records
- [ ] Spatial queries return correct results
- [ ] Error logs capture problematic records
- [ ] Documentation files are complete and accurate

## Files Modified

- `scripts/test-import-e2e.sh` (new)
- `docs/delivery/3/IMPORT-GUIDE.md` (new - user documentation)


