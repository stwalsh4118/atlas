# [3-5] Add geometry validation and repair

[Back to task list](./tasks.md)

## Description

Enhance the import pipeline with geometry validation using PostGIS functions (ST_IsValid, ST_MakeValid). After import, this script will check all geometries for validity issues and attempt automatic repairs, logging any geometries that cannot be fixed.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-20 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Check all imported geometries with ST_IsValid
2. Attempt to repair invalid geometries using ST_MakeValid
3. Log invalid geometries with parcel_id for troubleshooting
4. Count and report:
   - Total geometries checked
   - Number of invalid geometries found
   - Number successfully repaired
   - Number that could not be repaired
5. Optionally mark unrepaired geometries for review
6. Support running as standalone script or as part of import pipeline
7. Create output log file with detailed validation results

## Implementation Plan

1. Create script: `scripts/validate-geometries.sh`
2. Accept database connection parameters
3. Run ST_IsValid check on all geometries:
   ```sql
   SELECT parcel_id, ST_IsValid(geom), ST_IsValidReason(geom)
   FROM tax_parcels
   WHERE NOT ST_IsValid(geom);
   ```
4. For invalid geometries, attempt repair:
   ```sql
   UPDATE tax_parcels
   SET geom = ST_MakeValid(geom)
   WHERE parcel_id IN (list_of_invalid_ids);
   ```
5. Re-check geometries after repair
6. Log results to file: `logs/geometry-validation-YYYYMMDD-HHMMSS.log`
7. Generate summary report
8. Update import script to call validation automatically

## Test Plan

**Objective**: Verify geometry validation correctly identifies and repairs invalid geometries

**Test Scope**: SQL validation logic and bash script orchestration

**Key Test Scenarios**:
1. Script identifies geometries with validation issues
2. ST_MakeValid successfully repairs common issues
3. Script logs parcel_ids of invalid geometries
4. Script generates accurate summary counts
5. Script can be run standalone (post-import)
6. Script integrates with import pipeline

**Success Criteria**: 
- Script runs without errors
- All geometries are validated using ST_IsValid
- Invalid geometries are attempted to be repaired
- Detailed log file is created
- Summary report shows validation statistics
- Unrepaired geometries are clearly logged

## Verification

- [ ] Script created at `scripts/validate-geometries.sh`
- [ ] Script is executable (chmod +x)
- [ ] Script checks all geometries with ST_IsValid
- [ ] Script attempts repair with ST_MakeValid
- [ ] Script logs invalid geometries with parcel_id
- [ ] Script generates summary counts
- [ ] Log file created with timestamp
- [ ] Script integrated into import pipeline
- [ ] Script tested with Montgomery County data
- [ ] Documentation includes example output

## Files Modified

- `scripts/validate-geometries.sh` (new)
- `scripts/import-parcels.sh` (modified to call validation)


