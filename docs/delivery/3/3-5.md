# [3-5] Add geometry validation and repair

[Back to task list](./tasks.md)

## Description

Enhance the import pipeline with geometry validation using PostGIS functions (ST_IsValid, ST_MakeValid). After import, this script will check all geometries for validity issues and attempt automatic repairs, logging any geometries that cannot be fixed.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-20 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-20 17:00:00 | Status Change | Proposed | Agreed | Task approved by User | User |
| 2025-10-20 17:00:01 | Status Change | Agreed | InProgress | Starting implementation of geometry validation | AI_Agent |
| 2025-10-20 17:05:00 | Status Change | InProgress | Review | Implementation complete, tested with Montgomery County data | AI_Agent |
| 2025-10-20 17:10:00 | Status Change | Review | Done | Task approved and completed | User |

## Requirements

1. Check all imported geometries with ST_IsValid
2. Attempt to repair invalid geometries using ST_MakeValid
3. Log invalid geometries with parcel_id for troubleshooting
4. Count and report:
   - Total geometries checked
   - Number of invalid geometries found
   - Number successfully repaired
   - Number that could not be repaired
5. Optionally mark unrepaired geometries for review
6. Support running as standalone script or as part of import pipeline
7. Create output log file with detailed validation results

## Implementation Plan

1. Create script: `scripts/validate-geometries.sh`
2. Accept database connection parameters
3. Run ST_IsValid check on all geometries:
   ```sql
   SELECT parcel_id, ST_IsValid(geom), ST_IsValidReason(geom)
   FROM tax_parcels
   WHERE NOT ST_IsValid(geom);
   ```
4. For invalid geometries, attempt repair:
   ```sql
   UPDATE tax_parcels
   SET geom = ST_MakeValid(geom)
   WHERE parcel_id IN (list_of_invalid_ids);
   ```
5. Re-check geometries after repair
6. Log results to file: `logs/geometry-validation-YYYYMMDD-HHMMSS.log`
7. Generate summary report
8. Update import script to call validation automatically

## Test Plan

**Objective**: Verify geometry validation correctly identifies and repairs invalid geometries

**Test Scope**: SQL validation logic and bash script orchestration

**Key Test Scenarios**:
1. Script identifies geometries with validation issues
2. ST_MakeValid successfully repairs common issues
3. Script logs parcel_ids of invalid geometries
4. Script generates accurate summary counts
5. Script can be run standalone (post-import)
6. Script integrates with import pipeline

**Success Criteria**: 
- Script runs without errors
- All geometries are validated using ST_IsValid
- Invalid geometries are attempted to be repaired
- Detailed log file is created
- Summary report shows validation statistics
- Unrepaired geometries are clearly logged

## Verification

- [x] Script created at `scripts/validate-geometries.sh`
- [x] Script is executable (chmod +x)
- [x] Script checks all geometries with ST_IsValid
- [x] Script attempts repair with ST_MakeValid
- [x] Script logs invalid geometries with parcel_id and coordinates
- [x] Script generates summary counts
- [x] Log file created with timestamp: `logs/geometry-validation-YYYYMMDD-HHMMSS.log`
- [x] Script integrated into import pipeline with `--validate-geometries` flag
- [x] Script tested with Montgomery County data (found and repaired 62 invalid geometries)
- [x] Documentation includes example output

## Files Modified

- `scripts/validate-geometries.sh` (new - 600+ lines)
- `scripts/import-parcels.sh` (modified to add `--validate-geometries` flag)

## Implementation Notes

Successfully implemented comprehensive geometry validation and repair system:

1. **Standalone Script** (`validate-geometries.sh`):
   - Full database connection handling with parameter support
   - PostGIS version detection and validation
   - ST_IsValid checks on all geometries in tax_parcels table
   - ST_IsValidReason logging for detailed error analysis
   - ST_MakeValid automatic repair for invalid geometries
   - Timestamped log files with full audit trail
   - Summary statistics with repair counts
   - Exit codes: 0 if all valid, 1 if issues remain

2. **Features**:
   - `--no-repair` flag for check-only mode
   - `--dry-run` flag for preview without changes
   - Consistent logging format matching import script
   - Performance tracking (duration, geometries/sec)
   - Colored console output + structured log files

3. **Integration with Import Pipeline**:
   - Added `--validate-geometries` flag to import-parcels.sh
   - Optional validation runs after field mapping, before final stats
   - Validation results logged to import log file
   - Warnings logged if validation finds issues

4. **Testing Results** (Montgomery County, 325,071 parcels):
   - **Total Geometries Checked**: 324,597
   - **Invalid Geometries Found**: 62 (0.02%)
   - **Successfully Repaired**: 62 (100%)
   - **Still Invalid**: 0
   - **Duration**: 2 seconds
   - **Issues Found**:
     - Ring Self-intersections: ~30 parcels (polygons crossing themselves)
     - Nested shells: ~32 parcels (improperly nested internal rings)

5. **Log File Output**:
   ```
   [2025-10-20 17:03:41] [INFO] NOTICE:  Ring Self-intersection at or near point -95.591648256502296 30.136244227715
   [2025-10-20 17:03:41] [INFO] NOTICE:  Nested shells at or near point -95.466252747054597 30.1446096970238
   ```

**Performance**: Validates 324k geometries in ~2 seconds (~162k geometries/second)

**ST_MakeValid Strategy**: PostGIS ST_MakeValid uses sophisticated algorithms to repair:
- Self-intersections: Splits polygons at intersection points
- Nested shells: Reorganizes polygon structure to comply with OGC Simple Features spec
- Other topology issues: Applies appropriate fixes based on geometry type


