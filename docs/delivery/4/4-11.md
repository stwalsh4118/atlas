# [4-11] E2E CoS Test for Core Go API Backend

[Back to task list](./tasks.md)

## Description

Create comprehensive end-to-end tests that verify all Conditions of Satisfaction (CoS) for PBI 4 are met. This includes testing the complete API stack from startup to shutdown, all endpoints, middleware, database connectivity, and error handling.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-21 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Create E2E test suite in test/integration/
2. Test all acceptance criteria from PBI 4
3. Test complete application lifecycle
4. Test all health check endpoints
5. Test middleware functionality (CORS, logging, recovery)
6. Test graceful shutdown
7. Test error scenarios (DB unavailable, invalid config)
8. Test with real PostgreSQL database
9. Use testcontainers or Docker Compose for isolated testing

## Implementation Plan

1. Create `test/integration/api_e2e_test.go`
2. Set up test fixtures:
   - Start test database (testcontainers or existing Docker)
   - Create test configuration
   - Initialize application
3. Test CoS 1-2: Go module and Gin server
   - Verify go.mod has all dependencies
   - Start Gin server on test port
   - Verify server is listening
4. Test CoS 3-5: Configuration and database
   - Load config from environment
   - Verify database pool created
   - Verify connection pool health check
5. Test CoS 6-9: Health endpoints
   - Test GET /health returns 200
   - Test GET /health/ready returns 200 when DB connected
   - Test GET /health/ready returns 503 when DB unavailable
   - Test GET /api/v1/info returns metadata
6. Test CoS 10-12: CORS, logging, and recovery
   - Test CORS headers for localhost:3000
   - Verify request logging captures all fields
   - Test panic recovery middleware
7. Test CoS 13: Graceful shutdown
   - Send SIGTERM to running server
   - Verify shutdown completes within timeout
   - Verify database connections closed
8. Test CoS 14: Linting
   - Run golangci-lint programmatically
   - Verify no errors
9. Test CoS 15-16: README and connectivity
   - Verify README exists and has required sections
   - Test curl/HTTP client connectivity
10. Create test helpers for common operations
11. Add test documentation

## Test Plan

**Objective**: Verify all PBI 4 acceptance criteria are met through automated E2E tests

**Test Scope**: Complete API functionality from startup to shutdown

**Key Test Scenarios**:

### 1. Application Startup
- Application starts with valid configuration
- Database connection established
- Server listens on configured port

### 2. Health Endpoints
- /health always returns 200
- /health/ready returns 200 with DB connected
- /health/ready returns 503 with DB disconnected  
- /api/v1/info returns correct metadata

### 3. Middleware
- CORS headers set for allowed origins
- CORS blocks requests from non-allowed origins
- All requests are logged with structured fields
- Panic recovery catches errors and returns 500

### 4. Graceful Shutdown
- SIGTERM triggers shutdown
- Shutdown completes within timeout
- Database connections closed
- In-flight requests complete

### 5. Error Handling
- Invalid configuration prevents startup
- Database unavailability is detected
- Errors are logged appropriately

### 6. Code Quality
- golangci-lint passes with no errors
- All dependencies in go.mod
- README is complete and accurate

**Success Criteria**:
- All E2E tests pass
- Tests can be run in CI/CD environment
- Tests are reliable and repeatable
- All PBI 4 CoS are verified
- Test suite completes in < 2 minutes

## Verification

- [ ] E2E test suite created
- [ ] Test fixtures for database setup
- [ ] Tests for application startup
- [ ] Tests for all health check endpoints
- [ ] Tests for middleware (CORS, logging, recovery)
- [ ] Tests for graceful shutdown
- [ ] Tests for error scenarios
- [ ] Tests for code quality (linting)
- [ ] Test documentation added
- [ ] All E2E tests pass
- [ ] Tests run successfully in isolated environment
- [ ] CI/CD integration ready (if applicable)

## Files Modified

- `test/integration/api_e2e_test.go` (new)
- `test/integration/fixtures.go` (new - test helpers)
- `test/integration/README.md` (new - test documentation)

