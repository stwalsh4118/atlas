# [4-5] Setup Gin router with middleware stack

[Back to task list](./tasks.md)

## Description

Create the middleware stack for the Gin HTTP framework, including CORS middleware, request logging middleware, panic recovery middleware, and request ID middleware. This establishes the HTTP request processing pipeline.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-21 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-21 01:05:00 | Status Change | Proposed | Agreed | Task approved by User | User |
| 2025-10-21 01:05:01 | Status Change | Agreed | InProgress | Starting middleware implementation | AI_Agent |
| 2025-10-21 01:20:00 | Status Change | InProgress | Review | Middleware stack implemented with 90.9% test coverage | AI_Agent |
| 2025-10-21 01:25:00 | Update | Review | Review | Switched to official gin-contrib/cors middleware for better reliability | AI_Agent |

## Requirements

1. Create middleware package in internal/middleware/
2. Implement CORS middleware with configurable origins
3. Implement request logging middleware using zerolog
4. Implement panic recovery middleware
5. Implement request ID middleware using UUID
6. Log all requests with structured fields:
   - request_id, method, path, status_code, duration_ms
7. CORS should allow configured origins from config
8. Recovery middleware should log panics and return 500 error
9. Request ID should be added to request context and response headers

## Implementation Plan

1. Create middleware files:
   - `api/internal/middleware/cors.go`
   - `api/internal/middleware/logger.go`
   - `api/internal/middleware/recovery.go`
   - `api/internal/middleware/request_id.go`

2. Implement CORS middleware:
   ```go
   func CORS(origins []string) gin.HandlerFunc
   ```
   - Set Access-Control-Allow-Origin
   - Set Access-Control-Allow-Methods
   - Set Access-Control-Allow-Headers
   - Handle preflight OPTIONS requests

3. Implement Logger middleware:
   ```go
   func Logger(logger *logger.Logger) gin.HandlerFunc
   ```
   - Capture start time
   - Call next handler
   - Calculate duration
   - Log request with structured fields

4. Implement Recovery middleware:
   ```go
   func Recovery(logger *logger.Logger) gin.HandlerFunc
   ```
   - Recover from panics
   - Log panic with stack trace
   - Return 500 Internal Server Error

5. Implement RequestID middleware:
   ```go
   func RequestID() gin.HandlerFunc
   ```
   - Generate UUID for each request
   - Store in Gin context
   - Add X-Request-ID header to response

6. Create helper to get request ID from context

## Test Plan

**Objective**: Verify all middleware functions correctly and integrates with Gin

**Test Scope**: Each middleware component and their integration

**Key Test Scenarios**:
1. CORS middleware sets correct headers for allowed origins
2. CORS middleware rejects requests from non-allowed origins
3. Logger middleware logs requests with all required fields
4. Recovery middleware catches panics and returns 500
5. Recovery middleware logs panic details
6. Request ID middleware generates unique IDs
7. Request ID is available in context and response headers
8. Middleware stack works correctly when chained

**Success Criteria**:
- All middleware components work independently
- Middleware can be chained without conflicts
- CORS allows configured origins only
- All requests are logged with structured data
- Panics are caught and logged
- Request IDs are unique and accessible

## Verification

- [x] cors.go created with CORS middleware
- [x] logger.go created with Logger middleware  
- [x] recovery.go created with Recovery middleware
- [x] request_id.go created with RequestID middleware
- [x] CORS handles preflight requests correctly
- [x] Logger logs all required fields (method, path, status, duration, IP, user agent)
- [x] Recovery catches panics and returns 500 with request ID
- [x] Request ID added to context and response headers
- [x] Helper functions: GetRequestID(), GetLogger()
- [x] Unit tests created for each middleware:
  - CORS with allowed/disallowed origins and OPTIONS handling
  - Logger with request/response capture and query params
  - Recovery with panic scenarios and normal requests
  - Request ID generation, propagation, and existing ID reuse
- [x] Integration test with full middleware stack
- [x] All tests pass (87.5% coverage with gin-contrib/cors)

## Implementation Notes

- Complete middleware stack implemented for Gin HTTP framework
- **RequestID middleware**: Generates UUIDs, supports existing IDs from upstream
- **CORS middleware**: Uses official `gin-contrib/cors` package for mature, battle-tested CORS handling with configurable origins and preflight support
- **Logger middleware**: Structured logging with request details, duration tracking, context-aware logging
- **Recovery middleware**: Panic recovery with stack traces, returns 500 with request ID
- Helper functions for accessing request ID and logger from Gin context
- Middleware integration: All middleware work seamlessly together
- Comprehensive logging: Different log levels based on status codes (info for 2xx, warn for 4xx, error for 5xx)
- Test coverage: 87.5% with 14 test cases covering all scenarios
- All tests passing including full middleware stack integration test
- Using industry-standard gin-contrib/cors instead of custom implementation for better reliability and maintenance

## Files Modified

- `api/internal/middleware/cors.go` (new)
- `api/internal/middleware/logger.go` (new)
- `api/internal/middleware/recovery.go` (new)
- `api/internal/middleware/request_id.go` (new)
- `api/internal/middleware/middleware_test.go` (new)

