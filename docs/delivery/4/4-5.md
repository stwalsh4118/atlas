# [4-5] Setup Gin router with middleware stack

[Back to task list](./tasks.md)

## Description

Create the middleware stack for the Gin HTTP framework, including CORS middleware, request logging middleware, panic recovery middleware, and request ID middleware. This establishes the HTTP request processing pipeline.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-21 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Create middleware package in internal/middleware/
2. Implement CORS middleware with configurable origins
3. Implement request logging middleware using zerolog
4. Implement panic recovery middleware
5. Implement request ID middleware using UUID
6. Log all requests with structured fields:
   - request_id, method, path, status_code, duration_ms
7. CORS should allow configured origins from config
8. Recovery middleware should log panics and return 500 error
9. Request ID should be added to request context and response headers

## Implementation Plan

1. Create middleware files:
   - `api/internal/middleware/cors.go`
   - `api/internal/middleware/logger.go`
   - `api/internal/middleware/recovery.go`
   - `api/internal/middleware/request_id.go`

2. Implement CORS middleware:
   ```go
   func CORS(origins []string) gin.HandlerFunc
   ```
   - Set Access-Control-Allow-Origin
   - Set Access-Control-Allow-Methods
   - Set Access-Control-Allow-Headers
   - Handle preflight OPTIONS requests

3. Implement Logger middleware:
   ```go
   func Logger(logger *logger.Logger) gin.HandlerFunc
   ```
   - Capture start time
   - Call next handler
   - Calculate duration
   - Log request with structured fields

4. Implement Recovery middleware:
   ```go
   func Recovery(logger *logger.Logger) gin.HandlerFunc
   ```
   - Recover from panics
   - Log panic with stack trace
   - Return 500 Internal Server Error

5. Implement RequestID middleware:
   ```go
   func RequestID() gin.HandlerFunc
   ```
   - Generate UUID for each request
   - Store in Gin context
   - Add X-Request-ID header to response

6. Create helper to get request ID from context

## Test Plan

**Objective**: Verify all middleware functions correctly and integrates with Gin

**Test Scope**: Each middleware component and their integration

**Key Test Scenarios**:
1. CORS middleware sets correct headers for allowed origins
2. CORS middleware rejects requests from non-allowed origins
3. Logger middleware logs requests with all required fields
4. Recovery middleware catches panics and returns 500
5. Recovery middleware logs panic details
6. Request ID middleware generates unique IDs
7. Request ID is available in context and response headers
8. Middleware stack works correctly when chained

**Success Criteria**:
- All middleware components work independently
- Middleware can be chained without conflicts
- CORS allows configured origins only
- All requests are logged with structured data
- Panics are caught and logged
- Request IDs are unique and accessible

## Verification

- [ ] cors.go created with CORS middleware
- [ ] logger.go created with Logger middleware  
- [ ] recovery.go created with Recovery middleware
- [ ] request_id.go created with RequestID middleware
- [ ] CORS handles preflight requests correctly
- [ ] Logger logs all required fields (method, path, status, duration)
- [ ] Recovery catches panics and returns 500
- [ ] Request ID added to context and response headers
- [ ] Unit tests created for each middleware:
  - CORS with allowed/disallowed origins
  - Logger with request/response capture
  - Recovery with panic scenarios
  - Request ID generation and propagation
- [ ] Integration test with full middleware stack
- [ ] All tests pass

## Files Modified

- `api/internal/middleware/cors.go` (new)
- `api/internal/middleware/logger.go` (new)
- `api/internal/middleware/recovery.go` (new)
- `api/internal/middleware/request_id.go` (new)
- `api/internal/middleware/middleware_test.go` (new)

