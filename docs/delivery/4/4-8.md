# [4-8] Add error handling utilities

[Back to task list](./tasks.md)

## Description

Create standardized error response structures and utility functions for consistent error handling across the API. This includes defining error response format, error codes, and helper functions for common error scenarios.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-21 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Create errors package in internal/errors/
2. Define standardized error response structure
3. Define common error codes (constants)
4. Implement helper functions for common errors:
   - NotFound
   - BadRequest
   - InternalServerError
   - ValidationError
5. Support error details (additional context)
6. Integrate with Gin context for JSON responses
7. Log errors with appropriate levels (warn for 4xx, error for 5xx)

## Implementation Plan

1. Create `api/internal/errors/errors.go`
2. Define ErrorResponse structure:
   ```go
   type ErrorResponse struct {
       Error ErrorDetail `json:"error"`
   }
   
   type ErrorDetail struct {
       Code    string                 `json:"code"`
       Message string                 `json:"message"`
       Details map[string]interface{} `json:"details,omitempty"`
   }
   ```
3. Define error code constants:
   ```go
   const (
       ErrNotFound           = "NOT_FOUND"
       ErrBadRequest         = "BAD_REQUEST"
       ErrInternalServer     = "INTERNAL_SERVER_ERROR"
       ErrValidation         = "VALIDATION_ERROR"
       ErrDatabaseConnection = "DATABASE_CONNECTION_ERROR"
   )
   ```
4. Implement helper functions:
   ```go
   func NotFound(c *gin.Context, message string)
   func BadRequest(c *gin.Context, message string, details map[string]interface{})
   func InternalServerError(c *gin.Context, message string, err error)
   func ValidationError(c *gin.Context, validationErrors validator.ValidationErrors)
   ```
5. Each helper should:
   - Create ErrorResponse
   - Log error with appropriate level
   - Call c.JSON with correct status code
6. Add logging integration (pass logger to functions or use context)

## Test Plan

**Objective**: Verify error responses are consistently formatted and logged

**Test Scope**: Error response structure and helper functions

**Key Test Scenarios**:
1. NotFound returns 404 with correct JSON structure
2. BadRequest returns 400 with details
3. InternalServerError returns 500 and logs error
4. ValidationError returns 400 with field-specific errors
5. All error responses match defined structure
6. Errors are logged with appropriate severity

**Success Criteria**:
- All error helpers produce consistent JSON format
- HTTP status codes are correct for each error type
- Validation errors include field-specific details
- Internal errors are logged but don't expose internals
- Unit tests verify error response structure
- Integration tests verify error handling in handlers

## Verification

- [ ] errors.go created with ErrorResponse structure
- [ ] Error code constants defined
- [ ] NotFound helper implemented
- [ ] BadRequest helper implemented
- [ ] InternalServerError helper implemented
- [ ] ValidationError helper implemented
- [ ] Logging integrated for all error types
- [ ] Error details support implemented
- [ ] Unit tests created for:
  - Each error helper function
  - JSON response structure
  - HTTP status codes
  - Logging behavior
- [ ] All tests pass

## Files Modified

- `api/internal/errors/errors.go` (new)
- `api/internal/errors/errors_test.go` (new)

