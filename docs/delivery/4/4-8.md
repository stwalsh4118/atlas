# [4-8] Add error handling utilities

[Back to task list](./tasks.md)

## Description

Create standardized error response structures and utility functions for consistent error handling across the API. This includes defining error response format, error codes, and helper functions for common error scenarios.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-21 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-21 22:00:00 | Status Change | Proposed | InProgress | Starting error handling utilities implementation | AI_Agent |
| 2025-10-21 22:30:00 | Status Change | InProgress | Review | Completed error handling utilities with 100% test coverage | AI_Agent |
| 2025-10-21 23:00:00 | Status Change | Review | Done | Task approved and completed | User |

## Requirements

1. Create errors package in internal/errors/
2. Define standardized error response structure
3. Define common error codes (constants)
4. Implement helper functions for common errors:
   - NotFound
   - BadRequest
   - InternalServerError
   - ValidationError
5. Support error details (additional context)
6. Integrate with Gin context for JSON responses
7. Log errors with appropriate levels (warn for 4xx, error for 5xx)

## Implementation Plan

1. Create `api/internal/errors/errors.go`
2. Define ErrorResponse structure:
   ```go
   type ErrorResponse struct {
       Error ErrorDetail `json:"error"`
   }
   
   type ErrorDetail struct {
       Code    string                 `json:"code"`
       Message string                 `json:"message"`
       Details map[string]interface{} `json:"details,omitempty"`
   }
   ```
3. Define error code constants:
   ```go
   const (
       ErrNotFound           = "NOT_FOUND"
       ErrBadRequest         = "BAD_REQUEST"
       ErrInternalServer     = "INTERNAL_SERVER_ERROR"
       ErrValidation         = "VALIDATION_ERROR"
       ErrDatabaseConnection = "DATABASE_CONNECTION_ERROR"
   )
   ```
4. Implement helper functions:
   ```go
   func NotFound(c *gin.Context, message string)
   func BadRequest(c *gin.Context, message string, details map[string]interface{})
   func InternalServerError(c *gin.Context, message string, err error)
   func ValidationError(c *gin.Context, validationErrors validator.ValidationErrors)
   ```
5. Each helper should:
   - Create ErrorResponse
   - Log error with appropriate level
   - Call c.JSON with correct status code
6. Add logging integration (pass logger to functions or use context)

## Test Plan

**Objective**: Verify error responses are consistently formatted and logged

**Test Scope**: Error response structure and helper functions

**Key Test Scenarios**:
1. NotFound returns 404 with correct JSON structure
2. BadRequest returns 400 with details
3. InternalServerError returns 500 and logs error
4. ValidationError returns 400 with field-specific errors
5. All error responses match defined structure
6. Errors are logged with appropriate severity

**Success Criteria**:
- All error helpers produce consistent JSON format
- HTTP status codes are correct for each error type
- Validation errors include field-specific details
- Internal errors are logged but don't expose internals
- Unit tests verify error response structure
- Integration tests verify error handling in handlers

## Implementation Notes

- **Error Response Structure**: Consistent JSON format with `error.code`, `error.message`, `error.details` (optional), and `error.request_id`
- **Error Code Constants**: Five predefined constants (NOT_FOUND, BAD_REQUEST, INTERNAL_SERVER_ERROR, VALIDATION_ERROR, DATABASE_CONNECTION_ERROR)
- **Helper Functions**: Four main helpers (NotFound, BadRequest, InternalServerError, ValidationError)
- **Logger Integration**: All helpers retrieve logger from Gin context using `middleware.GetLogger(c)`
- **Request ID**: Automatically included in error responses using `middleware.GetRequestID(c)`
- **Logging Levels**: 
  - Warn level for 4xx errors (NotFound, BadRequest, ValidationError)
  - Error level for 5xx errors (InternalServerError)
- **Validation Error Formatting**: Comprehensive formatValidationError function supporting 12+ validation tags (required, email, min, max, len, gt, gte, lt, lte, oneof, url, uuid)
- **Security**: InternalServerError logs full error details but only returns generic message to client
- **Test Coverage**: 100% code coverage with comprehensive unit tests for all scenarios
- **Graceful Degradation**: Error helpers work correctly even without logger/request ID in context

## Verification

- [x] errors.go created with ErrorResponse structure
- [x] Error code constants defined
- [x] NotFound helper implemented
- [x] BadRequest helper implemented
- [x] InternalServerError helper implemented
- [x] ValidationError helper implemented
- [x] Logging integrated for all error types
- [x] Error details support implemented
- [x] Unit tests created for:
  - Each error helper function
  - JSON response structure
  - HTTP status codes
  - Logging behavior
- [x] All tests pass (100% coverage)

## Files Modified

- `api/internal/errors/errors.go` (new)
- `api/internal/errors/errors_test.go` (new)

