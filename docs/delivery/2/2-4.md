# [2-4] Create GORM model with custom geometry type

[Back to task list](./tasks.md)

## Description

Create the TaxParcel GORM model with a custom Polygon geometry type that implements GORM's Scanner and Valuer interfaces. This allows GORM to handle the geometry column while using PostGIS for spatial operations.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-20 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-20 11:00:00 | Status Change | Proposed | Agreed | Task approved by User | User |
| 2025-10-20 11:00:01 | Status Change | Agreed | InProgress | Starting GORM model implementation | AI_Agent |
| 2025-10-20 11:15:00 | Status Change | InProgress | Review | Models created and tested successfully | AI_Agent |
| 2025-10-20 11:20:00 | Status Change | Review | Done | Task approved by User | User |

## Requirements

1. Define custom Polygon type that implements sql.Scanner and driver.Valuer
2. Create TaxParcel struct with GORM tags matching database schema
3. Include all fields from Montgomery County GeoJSON data
4. Support GeoJSON parsing for geometry data
5. Include helper methods for common operations
6. Add proper GORM table name configuration

## Implementation Plan

1. Create `api/internal/models/geometry.go`:
   - Define Polygon type struct
   - Implement Scanner interface (reads from DB)
   - Implement Valuer interface (writes to DB)
   - Add GeoJSON marshaling/unmarshaling

2. Create `api/internal/models/tax_parcel.go`:
   - Define TaxParcel struct with all fields
   - Add GORM field tags
   - Add JSON tags for API responses
   - Implement TableName() method
   - Add validation tags if needed

3. Map all Montgomery County fields to Go struct:
   - Use appropriate Go types (int, string, time.Time)
   - Make fields nullable where appropriate (use pointers)
   - Use proper GORM column tags

4. Reference the research from task 2-1 for implementation patterns

## Test Plan

**Objective**: Verify GORM model compiles and geometry type works with database

**Environment**: Local PostgreSQL with PostGIS enabled

**Test Scope**: Model definition and basic type functionality

**Key Test Scenarios**:
1. **Compilation**: Go code compiles without errors
2. **Type Safety**: Polygon type implements required interfaces
3. **GORM Integration**: Can create GORM DB instance with model
4. **Serialization**: Can marshal/unmarshal geometry to/from database format

**Success Criteria**:
- Code compiles with no errors
- GORM recognizes TaxParcel as a valid model
- Geometry type can be scanned from database
- Type checks pass for Scanner and Valuer interfaces

## Verification

- [x] `api/internal/models/geometry.go` created with Polygon type
- [x] Polygon implements sql.Scanner interface (verified via test)
- [x] Polygon implements driver.Valuer interface (verified via test)
- [x] `api/internal/models/tax_parcel.go` created with TaxParcel struct
- [x] All Montgomery County fields mapped correctly (31 fields + timestamps)
- [x] GORM tags match database column names from PRD schema
- [x] Code compiles without errors
- [x] No linter errors
- [x] Comprehensive tests created and passing (4 test suites, all pass)
- [x] JSON marshaling/unmarshaling tested for API compatibility
- [x] GORM v1.31.0 and postgres driver v1.6.0 added to dependencies

## Implementation Notes

- Created custom Polygon type with GeoJSON coordinate structure [rings][points][lon,lat]
- Implemented Scanner interface for reading PostGIS geometry as GeoJSON from database
- Implemented Valuer interface for writing GeoJSON to PostGIS via ST_GeomFromGeoJSON
- Added JSON marshaling/unmarshaling for API responses and Montgomery County data parsing
- TaxParcel model includes all 31 fields from PRD schema plus auto-managed timestamps
- Used pointer types (*string, *int) for nullable fields to distinguish NULL from zero values
- GORM tags precisely match column names and types from database schema
- Default SRID 4326 (WGS84) for all geometry data
- All tests pass (interface implementation, Value(), Scan(), JSON serialization)
- Zero linter errors after fixing nil slice check

## Files Modified

- `api/internal/models/geometry.go` (new - 109 lines)
- `api/internal/models/tax_parcel.go` (new - 59 lines)
- `api/internal/models/geometry_test.go` (new - 163 lines, 4 test suites)
- `api/go.mod` (updated - added GORM v1.31.0 and postgres driver v1.6.0)
- `api/go.sum` (updated)

