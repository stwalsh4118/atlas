# [2-6] Create standard indexes migration

[Back to task list](./tasks.md)

## Description

Create a migration that adds standard B-tree indexes on commonly queried non-spatial columns. These indexes will improve performance for queries filtering by PIN, owner name, address, and other frequently searched fields.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-20 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-20 12:00:00 | Status Change | Proposed | Agreed | Task approved by User | User |
| 2025-10-20 12:00:01 | Status Change | Agreed | InProgress | Starting standard indexes migration | AI_Agent |
| 2025-10-20 12:10:00 | Status Change | InProgress | Review | Migration created and tested successfully | AI_Agent |
| 2025-10-20 12:15:00 | Status Change | Review | Done | Task approved by User | User |

## Requirements

1. Create indexes on frequently queried columns
2. Include: pin, object_id, owner_name, situs, county_name
3. Use appropriate index types (B-tree for standard columns)
4. Name indexes clearly with idx_parcels_ prefix
5. Include both up and down migrations
6. Consider partial indexes if beneficial

## Implementation Plan

1. Create migration files:
   ```bash
   migrate create -ext sql -dir api/migrations -seq create_parcel_indexes
   ```

2. Write up migration (api/migrations/000003_create_parcel_indexes.up.sql):
   ```sql
   -- Index for PIN lookups (very common)
   CREATE INDEX idx_parcels_pin ON tax_parcels(pin);
   
   -- Index for OBJECTID lookups (unique identifier)
   CREATE INDEX idx_parcels_object_id ON tax_parcels(object_id);
   
   -- Index for owner name searches
   CREATE INDEX idx_parcels_owner_name ON tax_parcels(owner_name);
   
   -- Index for address searches
   CREATE INDEX idx_parcels_situs ON tax_parcels(situs);
   
   -- Index for county filtering (if multi-county in future)
   CREATE INDEX idx_parcels_county ON tax_parcels(county_name);
   ```

3. Write down migration (api/migrations/000003_create_parcel_indexes.down.sql):
   ```sql
   DROP INDEX IF EXISTS idx_parcels_county;
   DROP INDEX IF EXISTS idx_parcels_situs;
   DROP INDEX IF EXISTS idx_parcels_owner_name;
   DROP INDEX IF EXISTS idx_parcels_object_id;
   DROP INDEX IF EXISTS idx_parcels_pin;
   ```

4. Apply migration and verify indexes are created
5. Test query performance with EXPLAIN ANALYZE

## Test Plan

**Objective**: Verify standard indexes are created and improve query performance

**Environment**: Local PostgreSQL with tax_parcels table created

**Test Scope**: Index creation and basic performance validation

**Key Test Scenarios**:
1. **Index Creation**: All indexes created successfully
2. **Index Visibility**: Indexes appear in pg_indexes system catalog
3. **Query Plan**: EXPLAIN shows index usage for queries
4. **Rollback**: Down migration removes all indexes cleanly

**Success Criteria**:
- All 5 indexes created without errors
- Indexes visible in database metadata
- Query plans show index scans (when applicable)
- Can rollback migration cleanly

## Verification

- [x] Migration files created: `000003_create_parcel_indexes.up.sql` and `000003_create_parcel_indexes.down.sql`
- [x] Up migration creates all indexes successfully (12ms execution)
- [x] All 4 B-tree indexes visible in pg_indexes (pin, owner_name, situs, county_name)
- [x] Note: object_id already has index from UNIQUE constraint (no duplicate needed)
- [x] Test query uses index: `EXPLAIN SELECT * FROM tax_parcels WHERE pin = 99999;` shows "Index Scan using idx_parcels_pin"
- [x] Test query uses index: `EXPLAIN SELECT * FROM tax_parcels WHERE owner_name = 'Jane Smith';` shows "Index Scan using idx_parcels_owner_name"
- [x] Down migration removes all indexes cleanly (9ms execution)
- [x] Re-apply migration works correctly (10ms execution)
- [x] Migration version is now 3
- [x] Total indexes: 7 (4 new B-tree + 1 GiST spatial + 2 constraint indexes)

## Implementation Notes

- Created 4 B-tree indexes on commonly queried columns
- Did not create index on object_id (already has UNIQUE index: tax_parcels_object_id_key)
- Indexes created: idx_parcels_pin, idx_parcels_owner_name, idx_parcels_situs, idx_parcels_county
- Query plan verification shows indexes are being used for lookups
- Index creation executes in 12ms
- Clean rollback tested (9ms) - removes only the 4 new indexes
- Re-application tested successfully (10ms)
- Comments added for documentation
- Total database indexes now: 7 (supports all common query patterns)

## Files Modified

- `api/migrations/000003_create_parcel_indexes.up.sql` (new - 20 lines)
- `api/migrations/000003_create_parcel_indexes.down.sql` (new - 7 lines)

