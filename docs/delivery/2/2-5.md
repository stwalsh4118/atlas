# [2-5] Create tax_parcels table schema migration

[Back to task list](./tasks.md)

## Description

Create the migration that defines the tax_parcels table with all columns based on the Montgomery County GeoJSON data structure. This includes the geometry column with Polygon type and the critical GiST spatial index for efficient point-in-polygon queries.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-20 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Create migration for tax_parcels table with all 26+ columns
2. Use GEOMETRY(Polygon, 4326) for spatial column
3. Create GiST spatial index on geometry column
4. Include proper constraints (NOT NULL, UNIQUE, DEFAULT)
5. Add timestamps (created_at, updated_at)
6. Include both up and down migrations
7. Use exact schema from PBI 2 PRD

## Implementation Plan

1. Create migration files:
   ```bash
   migrate create -ext sql -dir api/migrations -seq create_tax_parcels_table
   ```

2. Write up migration (api/migrations/000002_create_tax_parcels_table.up.sql):
   - Create tax_parcels table with all columns
   - Add primary key on id
   - Add unique constraint on object_id
   - Add NOT NULL constraint on critical fields
   - Add default values where appropriate
   - Create GiST index on geom column (most critical for performance)

3. Write down migration (api/migrations/000002_create_tax_parcels_table.down.sql):
   - Drop GiST index first
   - Drop tax_parcels table

4. Apply migration to local database
5. Verify table structure matches schema

## Test Plan

**Objective**: Verify tax_parcels table is created with correct schema and spatial index

**Environment**: Local PostgreSQL with PostGIS enabled

**Mocking Strategy**: No mocks - testing against real database

**Key Test Scenarios**:
1. **Table Creation**: Migration creates table successfully
2. **Column Types**: All columns have correct data types
3. **Constraints**: Primary key, unique, and NOT NULL constraints work
4. **Spatial Index**: GiST index is created on geom column
5. **Index Performance**: Verify index exists in pg_indexes
6. **Rollback**: Down migration removes table cleanly

**Success Criteria**:
- Table created with all 26+ columns
- Geometry column accepts Polygon with SRID 4326
- GiST index exists and is functional
- Can insert test polygon data
- Can rollback migration cleanly

## Verification

- [ ] Migration files created: `000002_create_tax_parcels_table.up.sql` and `000002_create_tax_parcels_table.down.sql`
- [ ] Up migration creates tax_parcels table successfully
- [ ] Table has all required columns with correct types
- [ ] Primary key constraint on id column
- [ ] Unique constraint on object_id column
- [ ] Geometry column has type GEOMETRY(Polygon, 4326)
- [ ] GiST index exists on geom column: `SELECT * FROM pg_indexes WHERE tablename = 'tax_parcels' AND indexname LIKE '%geom%';`
- [ ] Can insert test polygon: `INSERT INTO tax_parcels (object_id, pin, geom, owner_name) VALUES (1, 12345, ST_GeomFromText('POLYGON((0 0, 1 0, 1 1, 0 1, 0 0))', 4326), 'Test Owner');`
- [ ] Down migration drops table and index cleanly

## Files Modified

- `api/migrations/000002_create_tax_parcels_table.up.sql` (new)
- `api/migrations/000002_create_tax_parcels_table.down.sql` (new)

