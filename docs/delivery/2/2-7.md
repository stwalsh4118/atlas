# [2-7] E2E CoS Test - Schema validation and testing

[Back to task list](./tasks.md)

## Description

End-to-end validation task that verifies all Conditions of Satisfaction (CoS) for PBI 2 are met. This includes testing the complete migration system, GORM model integration, data insertion, spatial queries, and performance validation.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-20 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

Validate all PBI 2 Acceptance Criteria:

1. PostGIS extension is enabled
2. tax_parcels table exists with correct schema
3. Geometry column uses SRID 4326
4. Geometry column enforces Polygon type
5. GiST spatial index exists on geom
6. Standard indexes exist on pin, object_id, owner_name, situs, county_name
7. golang-migrate system works correctly
8. GORM model works for CRUD operations
9. Can insert actual Montgomery County GeoJSON data
10. Can query using ST_Contains with raw SQL
11. Spatial query performance < 10ms (empty table)
12. VACUUM ANALYZE runs successfully

## Implementation Plan

1. **Database State Validation**:
   - Verify PostGIS version
   - Verify table schema matches design
   - Verify all indexes exist
   - Check constraints and column types

2. **Migration System Validation**:
   - Verify all 3 migrations applied
   - Test migration status command
   - Document migration workflow

3. **GORM Integration Testing**:
   - Test basic CRUD operations with GORM
   - Insert test records (non-spatial queries)
   - Query records by PIN, owner_name
   - Update records
   - Verify timestamps work

4. **GeoJSON Data Import Test**:
   - Parse Montgomery County GeoJSON sample
   - Insert 5-10 test parcels with real geometry
   - Verify geometry data persists correctly
   - Verify SRID is preserved

5. **Spatial Query Testing**:
   - Test ST_Contains with point-in-polygon query
   - Measure query performance with EXPLAIN ANALYZE
   - Verify GiST index is used in query plan
   - Validate < 10ms response time target

6. **Database Maintenance**:
   - Run VACUUM ANALYZE on table
   - Verify statistics are updated

## Test Plan

**Objective**: Comprehensive end-to-end validation of entire PBI 2 implementation

**Environment**: Local PostgreSQL 18 with PostGIS 3.5+, all migrations applied

**Test Scope**: Full system integration from migrations to queries

### Test Scenarios

#### 1. PostGIS Extension Validation
```sql
SELECT PostGIS_Version();
SELECT PostGIS_Full_Version();
```
Expected: PostGIS 3.5+ is installed and functional

#### 2. Schema Validation
```sql
SELECT 
    column_name, 
    data_type, 
    is_nullable, 
    column_default
FROM information_schema.columns 
WHERE table_name = 'tax_parcels'
ORDER BY ordinal_position;
```
Expected: All 26+ columns present with correct types

#### 3. Index Validation
```sql
SELECT 
    indexname, 
    indexdef 
FROM pg_indexes 
WHERE tablename = 'tax_parcels'
ORDER BY indexname;
```
Expected: 6 indexes (1 GiST spatial + 5 B-tree standard)

#### 4. GORM CRUD Operations
```go
// Test using GORM model
parcel := &models.TaxParcel{
    ObjectID: 12345,
    PIN: 67890,
    OwnerName: "Test Owner",
    // ... other fields
}
db.Create(parcel)
db.First(&found, "pin = ?", 67890)
db.Save(&found)
db.Delete(&found)
```
Expected: All CRUD operations work for non-spatial fields

#### 5. GeoJSON Import Test
- Parse Montgomery County GeoJSON sample feature
- Extract geometry and properties
- Insert using GORM + raw SQL for geometry
- Verify data persists

#### 6. Spatial Query Performance
```sql
EXPLAIN ANALYZE
SELECT 
    object_id, 
    pin, 
    owner_name, 
    situs
FROM tax_parcels
WHERE ST_Contains(geom, ST_SetSRID(ST_Point(-95.228, 30.065), 4326));
```
Expected: 
- Query uses GiST index (Index Scan in plan)
- Execution time < 10ms
- Returns correct results

#### 7. VACUUM ANALYZE
```sql
VACUUM ANALYZE tax_parcels;
SELECT 
    schemaname, 
    tablename, 
    last_vacuum, 
    last_analyze 
FROM pg_stat_user_tables 
WHERE tablename = 'tax_parcels';
```
Expected: Completes successfully, statistics updated

**Success Criteria**: All test scenarios pass, all acceptance criteria validated

## Verification

### Database State
- [ ] PostGIS extension enabled: `SELECT PostGIS_Version();` returns version
- [ ] tax_parcels table exists with correct schema
- [ ] Geometry column type: `GEOMETRY(Polygon, 4326)`
- [ ] GiST index exists on geom column
- [ ] All 5 standard indexes exist (pin, object_id, owner_name, situs, county_name)

### Migration System
- [ ] All migrations applied: `migrate -path api/migrations -database "..." version` shows version 3
- [ ] Can rollback and re-apply migrations without errors
- [ ] schema_migrations table tracks applied migrations

### GORM Integration
- [ ] Can create TaxParcel records with GORM
- [ ] Can query by PIN using GORM
- [ ] Can query by owner_name using GORM
- [ ] Can update records using GORM
- [ ] created_at and updated_at timestamps work

### GeoJSON Import
- [ ] Successfully parsed Montgomery County GeoJSON sample
- [ ] Inserted 5-10 real parcels with geometry
- [ ] Geometry data persists correctly
- [ ] SRID preserved: `SELECT ST_SRID(geom) FROM tax_parcels LIMIT 1;` returns 4326

### Spatial Queries
- [ ] ST_Contains query works: `SELECT COUNT(*) FROM tax_parcels WHERE ST_Contains(geom, ST_Point(-95.228, 30.065, 4326));`
- [ ] Query plan shows Index Scan using GiST index
- [ ] Query execution time < 10ms (EXPLAIN ANALYZE)
- [ ] ST_GeomFromGeoJSON works for inserting geometry

### Database Maintenance
- [ ] VACUUM ANALYZE completes successfully
- [ ] Table statistics updated in pg_stat_user_tables

## Files Modified

This task primarily validates existing work, but may create:
- Test SQL scripts for validation queries
- Test Go program for GORM validation
- Documentation of test results

