# [2-2] Set up golang-migrate for database migrations

[Back to task list](./tasks.md)

## Description

Install and configure golang-migrate as the database migration tool for the project. Set up the directory structure for migrations, create configuration, and document the migration workflow for the team.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-20 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-20 00:20:00 | Status Change | Proposed | Agreed | Task approved by User | User |
| 2025-10-20 00:20:01 | Status Change | Agreed | InProgress | Starting golang-migrate setup | AI_Agent |
| 2025-10-20 00:30:00 | Status Change | InProgress | Review | golang-migrate setup complete with documentation | AI_Agent |
| 2025-10-20 00:35:00 | Status Change | Review | Done | Task approved, WSL Docker connectivity fixed | User |

## Requirements

1. Install golang-migrate CLI tool
2. Add golang-migrate library to Go module dependencies
3. Create migrations directory structure in api/
4. Create migration configuration or helper scripts
5. Document migration commands (create, up, down, version)
6. Test basic migration workflow

## Implementation Plan

1. Add golang-migrate to api/go.mod:
   ```bash
   cd api
   go get -u github.com/golang-migrate/migrate/v4
   ```

2. Install CLI tool (document in README or scripts):
   ```bash
   go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
   ```

3. Create directory structure:
   ```
   api/
   ├── migrations/
   │   └── .gitkeep
   ```

4. Create helper script or Makefile for common migration commands

5. Document migration workflow in api/README.md or docs/technical/migrations.md

## Test Plan

**Objective**: Verify golang-migrate is properly installed and configured

**Environment**: Local development environment with PostgreSQL running

**Key Test Scenarios**:
1. Can create a test migration file using CLI
2. Can run migration up command successfully
3. Can run migration down command successfully
4. Can check migration version/status
5. schema_migrations table is created automatically

**Success Criteria**: 
- golang-migrate commands work without errors
- Can create, apply, and rollback test migrations
- Documentation is clear and accurate

## Verification

- [x] golang-migrate library added to api/go.mod (v4.19.0)
- [x] api/migrations/ directory exists with .gitkeep
- [x] Can run `migrate create -ext sql -dir api/migrations -seq test_migration`
- [x] Migration files created successfully (000001_test_migration.up.sql and .down.sql)
- [x] Makefile created with helper commands (migrate-up, migrate-down, migrate-create, etc.)
- [x] Migration workflow documented in api/README.md
- [x] golang-migrate CLI installed (`/home/sean/go/bin/migrate`)
- [x] Database migrations work via docker exec psql (tested)

## Implementation Notes

- golang-migrate v4.19.0 installed with postgres and file drivers
- Created comprehensive Makefile with 15+ migration and development commands
- Documented migration workflow, best practices, and troubleshooting in README
- Fixed WSL2 + Docker Desktop connectivity: Use `host.docker.internal` as DB_HOST
- Updated default DB_HOST in Makefile from `localhost` to `host.docker.internal`
- Test migration cycle verified: apply (11ms), rollback (10ms), re-apply successful
- Native Linux users can override with `DB_HOST=localhost`

## Files Modified

- `api/go.mod` (updated - added golang-migrate dependencies)
- `api/go.sum` (updated)
- `api/migrations/` (new directory with .gitkeep)
- `api/migrations/000001_test_migration.up.sql` (new - test file)
- `api/migrations/000001_test_migration.down.sql` (new - test file)
- `api/Makefile` (new - 15+ commands for migrations and development)
- `api/README.md` (new - comprehensive documentation)

