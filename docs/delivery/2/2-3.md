# [2-3] Create initial migration with PostGIS extension

[Back to task list](./tasks.md)

## Description

Create the first database migration that enables the PostGIS extension. This migration must run before any spatial data types can be used in subsequent migrations.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-20 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Create migration file for enabling PostGIS extension
2. Include both up and down migrations
3. Make the migration idempotent (safe to run multiple times)
4. Verify PostGIS version after enabling
5. Test migration can be applied and rolled back

## Implementation Plan

1. Create migration using golang-migrate CLI:
   ```bash
   migrate create -ext sql -dir api/migrations -seq enable_postgis
   ```

2. Write up migration (api/migrations/000001_enable_postgis.up.sql):
   ```sql
   -- Enable PostGIS extension
   CREATE EXTENSION IF NOT EXISTS postgis;
   
   -- Verify PostGIS is available
   SELECT PostGIS_Version();
   ```

3. Write down migration (api/migrations/000001_enable_postgis.down.sql):
   ```sql
   -- Disable PostGIS extension
   DROP EXTENSION IF EXISTS postgis CASCADE;
   ```

4. Apply migration to local database
5. Verify PostGIS functions are available
6. Test rollback (down migration)

## Test Plan

**Objective**: Verify PostGIS extension can be enabled via migration

**Environment**: Local PostgreSQL 18 with PostGIS 3.5+ available

**Mocking Strategy**: No mocks needed - testing against real database

**Key Test Scenarios**:
1. **Fresh database**: Run migration on database without PostGIS
2. **Idempotency**: Run migration twice (should succeed both times due to IF NOT EXISTS)
3. **PostGIS availability**: Query PostGIS functions after migration
4. **Rollback**: Run down migration and verify extension is removed
5. **Re-apply**: Run up migration again after rollback

**Success Criteria**: 
- Migration applies successfully on fresh database
- PostGIS functions (ST_Contains, ST_GeomFromGeoJSON) are available
- Can rollback and re-apply without errors
- No data loss concerns (no tables exist yet)

## Verification

- [ ] Migration files created: `000001_enable_postgis.up.sql` and `000001_enable_postgis.down.sql`
- [ ] Up migration enables PostGIS successfully
- [ ] Can query `SELECT PostGIS_Version();` after migration
- [ ] Can use spatial functions like `SELECT ST_Point(0, 0);`
- [ ] Down migration removes extension cleanly
- [ ] Can re-apply up migration after rollback

## Files Modified

- `api/migrations/000001_enable_postgis.up.sql` (new)
- `api/migrations/000001_enable_postgis.down.sql` (new)

